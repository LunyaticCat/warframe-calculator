<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Warframe Melee DPS</title>
		<link rel="stylesheet" href="design.css" />
		<link rel="shortcut icon" href="icon.png">

        <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        
        <script src="Warframe_Melee_DPS.js"></script>
    </head>
    
	<body>
        <div>
            <button onclick="changeStats()">Update Stats</button>
        </div>

        <div id="plotly" style="width:1500px;height:600px;"></div>
        <script>
            const colors = {
                "gas":          "rgb(25, 120, 50)",
                "toxin":        "rgb(130, 200, 90)",
                "electricity":  "rgb(40, 190, 250)",
                "heat":         "rgb(240, 130, 40)",
                "slash":        "rgb(150, 0, 0)",
                "damage":       "rgb(120, 120, 120)",
            };

            const labels = {
                slash:"slash DoT", 
                heat:"heat DoT", electricity:"electricity DoT",
                toxin: "toxin DoT", gas: "gas DoT"
            };

            function CppToColumnar(dataraw) {
                //convert to JS array
                const data = new Array(dataraw.size()).fill(0).map((_, id) => dataraw.get(id))

                //transpose into a dictionnary with arrays on each key
                const header_cols = ["time", "damage", "slash", "heat", "electricity", "toxin", "gas"];
                const ret = {};
                for (let i = header_cols.length - 1;0<=i; i--) {
                    ret[header_cols[i]] = data.map(row => row[i]);
                }
                return ret;
            }
        
			function changeStats() {
                const data = CppToColumnar(Module.stats());

                for (const key in data) {
                    data[key] = data[key].map(datum => Number(datum));// || undefined);
                }

                const time = data.time;
                delete data.time;
                
                const chart = document.getElementById('plotly');
                const configDefault = {
                    x: time,
                    type: 'scatter', //line //scatter //histogram
                    //mode: 'lines',
                    //histfunc: 'sum', //count
                    //xbins: {size: 1.0},
                    //fill: 'none', //tonexty //tozerox
                    //stackgroup: 'one',
                    hovertemplate: '%{x:.3f}s - %{y:.3s}',
                    transforms: [{
                        type: 'filter',
                        target: 'y',
                        operation: '>',
                        value: 0
                    }]
                }
                // creates an object for each column of the CSV
                const plotlyData = Object.entries(data).map(([name, data]) => ({
                    y: data,
                    name: labels[name] ?? name, //if not found, use the header
                    marker: {color: colors[name]},
                    //mode: 'lines+markers',
                    mode: 'markers',
                    /*
                    error_y: {
                        type: 'data',
                        array: data_error[name],
                        visible: true
                    },
                    */
                    ...configDefault,
                }));

                const layout = {
                    xaxis: {
                        //type: 'log',
                        //autorange: true
                    },
                    yaxis: {
                        range: [0, "auto"]
                        //type: 'log',
                        //autorange: true
                    },
                    //barmode: "stack",
                };
                Plotly.newPlot(chart, plotlyData, layout, {displaylogo: false});
            };
        </script>
    </body>
</html>